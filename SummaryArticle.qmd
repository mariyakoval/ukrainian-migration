---
format: 
  pdf
editor: 
  markdown: 
    wrap: 72
---

\begin{center}
\vspace*{-1cm}

{\LARGE \textbf{Path of Resilience: Job-Seeking Behavior of Ukrainian Refugees in Central and Eastern Europe}}\\[0.5cm]
Mariia
\end{center}

```{r, include=FALSE, warning=FALSE}

# Load necessary packages
if (!require('pacman')) install.packages('pacman'); library('pacman')
pacman::p_load(viridis, tidyverse, ggplot2, lubridate, knitr, dplyr, ggpubr, 
              janitor, tidyr, kableExtra, ggcorrplot, ggthemes, zoo, forcats,
              gridExtra, grid, Hmisc, FSA, dunn.test, readxl, RColorBrewer,
              patchwork, cowplot, pROC, rms)
# Load data
data_ee <- readRDS("Data/data_ee")
combined_df <- readRDS("Data/combined_df")
reasons_country_ee <- readRDS("Data/reasons_country_ee")
combined_data <- readRDS("Data/combined_data")
```

# Abstract

# Introduction and context

Since the start of the war in Ukraine, thousands of Ukrainians have been forced to leave the country and seek protection elsewhere. The inflow of more than 8 million Ukrainian refugees into Europe has introduced both challenges and opportunities for labour market outcomes. While it is hard to predict the intended length of stay of refugees in countries of the European Union, continued attacks made early returns very unpromising. 

The Temporary Protection Status enacted by European host countries in 2022 allows people fleeing the war in Ukraine to live and work in the European Union for up to 3 years. Finding work that best matches refugees' skills and education status is crucial in becoming financially stable and integrating into foreign society. Mastering their professional skills is also useful in reconstructing Ukraine in the future. Although the education and qualification levels of Ukrainian refugees are generally high, difficulties such as lack of language skills, childcare services and credential recognition processes pose significant barriers to employment. Instances of ethnic discrimination in the labor market have been reported, highlighting additional challenges faced by Ukrainian refugees (Londar et al., 2024). 

As the displacement persists, it is urgent to facilitate access to employment among Ukrainian refugees for long-term integration. The analysis is aimed at identifying key factors associated with successful job market outcomes to inform policy making and raise awareness on common obstacles, needs, and experiences faced by Ukrainians in European host countries. This study employs Multi-Sectoral Needs Assessments (MSNA) of 2023, which provide data on Ukrainian refugees' experiences in Estonia, Slovakia, Poland, Romania, Moldova, and Czechia. The assessment employs both household-level and individual-level data collected through structured surveys in all the countries. Regression analysis is used to identify significant factors associated with employment, both across the European Union as a whole and within each of the six host countries individually.

# Lives in Transition: Mapping the Road to Employment

The majority of Ukrainians coming to the European countries are women with children and retirees. The survey data analysis revealed that across all countries, the 35–59 age group dominates the refugee population, highlighting a significant presence of individuals with enough professional skills to contribute to labor market in the country of residence. The second largest group constitutes of people within the 18–34 year range, possibly represented by young professionals, interns, and trainees, while the 60+ demographic is least represented. Estonia stands out with a particularly high share of people aged 18-34, while balancing distribution between young and middle-aged adults. 
The variety of industries Ukrainian refugees can contribute to is highlighted by the variety of educational experiences they bring. Based on the data used in the analysis, most refugees possess at least secondary education (Figure ). Across all six countries, the proportion of individuals holding a Bachelor’s degree ranges from 12% to 19%, while Master’s degrees are more prevalent, ranging from 9% to as high as 40%, with particularly high shares observed in Slovakia and Romania. Although few hold PhDs, their presence is most visible in Slovakia. Notably, technical and vocational training is prevalent, suggesting that many refugees were skilled laborers, yet challenges remain in transferring those skills to host-country labor markets.

# Safety Nets and Struggles 

Before displacement, employment rates among Ukrainian refugees were high (60–70%), regardless of host country. However, after resettling in a new place, the picture changes drastically. Employment drops while unemployment, housekeeping, and studying rise sharply - particularly in Romania, Slovakia, and Poland, where about one-third of refugees are now unemployed. 

Numerous difficulties contribute to this shift, as reported by people themselves. The most common barrier to employment and immersion in European society among Ukrainians is lack of local language knowledge (Figure ). Despite education or professional background, Ukrainian refugees with weak language proficiency frequently get low-skilled or precarious jobs. This mismatch hinders their career growth and economic stability (Jirka et al., 2023). This is especially acute for those who previously worked in the areas of communication with people - teachers, lawyers, doctors. Lack of language knowledge is frequently cited among population of Ukrainians in Estonia and Romania. Conversely, proficiency in the host country’s language appears to be more common among Ukrainian refugees residing in neighboring Slavic-speaking countries (OECD, 2023). Meanwhile, Moldova and Slovakia report higher rates of respondents experiencing no employment difficulties. Other commonly cited barriers include "Not looking for work" and insufficient opportunities, suggesting both personal and structural factors at play.

Ukrainian refugees are often motivated to work to reduce dependence on social benefits provided by the government or other forms of humanitarian aid (OECD, 2023). Based on survey data, employment in the host country is the leading source of income, especially in Estonia, Poland, Czechia, and Slovakia - where it exceeds 40–50% (Figure ). Romania shows an even distribution among host-country jobs and alternative sources. Poland reveals higher-than-average reliance on remittances. While these numbers show promising trends, income insecurity remains a concern. Romania reports the highest number of refugees with no income, and in all countries, "No income" and "No answer" responses, though generally low, suggest hidden economic vulnerability. 

Even though Ukrainians have immediate right to work under Temporary Protection Status, some people rely on social benefits, housing, and other support services, especially if unable to find suitable employment. Based on the conducted surveys, cash benefits are the most widespread form of aid, reaching nearly 90% of respondents in countries like Czechia, Moldova, and Romania (Figure ). Poland differs drastically: over 80% of respondents there receive family grants instead. In Estonia, both cash and unemployment grants are the most common forms of aid. 

# Analyzing Key Factors Behind Refugees’ Labor Market Outcomes 

To identify factors influencing employment among Ukrainian refugees, a combination of statistical methods was used. First, a Random Forest analysis highlighted the 15 most important variables related to demographics, barriers, social benefits, and experiences. These variables were then examined more closely using a pooled logistic regression featuring all six countries of interest to understand how each one affected the likelihood of being employed.

Regression output revealed the significance of several elements, including age, prior activity, perceived difficulties, needs, and social benefits. The type of activity displaced individuals were engaged in while in Ukraine was the most important factor in predicting employment status. For instance, individuals primarily engaged in housekeeping activities in Ukraine were about 83% less likely to be employed, while those with long-term illness or injury faced even greater employment barriers. Age also played a role, with refugees aged 60 and above significantly less likely to be employed. In contrast, refugees reporting no perceived difficulties had more than seven times higher odds of being employed compared to those facing challenges. 

An unexpected result showed that reporting a lack of language skills was associated with a 60% increase in employment odds, suggesting underlying factors such as self-selection, possible skill mismatch, or employment in position with no language requirement. Other barriers negatively affecting employment included lack of childcare and presence of medical needs, which lowered employment chances by roughly 36% and 42%, respectively. Additionally, receiving unemployment grants or social protection benefits from host countries or Ukraine corresponded with lower employment odds, potentially reflecting temporary reliance on support.

The logistic regression model explained about 27% of the variation in employment outcomes - a moderate but meaningful level for social data - and correctly classified employment status for approximately 75% of individuals. It performed particularly well in identifying employed refugees, though there were some misclassifications among the unemployed. The model’s strong discriminatory ability, indicated by an AUC of 0.828, adds confidence to these insights.

# Six Countries, Six Realities: A Comparative View

To allow for cross-regional comparison of employment likelihood, a similar approach was used to analyze employment indicators Ukrainians in each country separately. The process began with exploratory data analysis, where key predictor variables were visually compared against employment status to identify noticeable differences between those employed and unemployed. Variables that showed clear distinctions or had adequate sample sizes were then selected for more detailed modeling.

Subsequently, multiple logistic regression models were developed separately for each country. Statistically insignificant predictors were repetitively removed to select the most important factors. In most cases, a significance level of 0.05 was applied to determine meaningful predictors, though a slightly higher threshold of 0.1 was occasionally used when exploratory analyses suggested relevant differences. While some common patterns emerge, each country’s unique context shapes distinct environments that define who finds work and under what conditions, as reflected by Table that shows significant predictors selected for each country individually.

**Age, Health, and Caregiving:** Similar to the pooled model, individual country models reveal that older refugees, particularly those aged 60 and above, face significantly lower odds of employment, with reductions ranging from around 60% in Romania to nearly 70% in Poland and Slovakia. This insight highlights the challenges related to the lack of suitable age opportunities. Other factors, such as long-term illness or injury, emerge as one of the most significant barriers to employment, with odds reduced by over 90% in countries like Poland, Moldova, and Czechia. The need to take care of others have negative association with employment, particularly in Romania and Moldova, where it reduces employment chances by more than half. 

**Pre-Migration Activity and Behavioral Factors:** Refugees’ main activities before arriving in Europe strongly influence their employment prospects. Engagement in housekeeping consistently corresponds with lower employment odds, ranging from an 80% reduction in Poland to over 90% in Estonia, indicating the difficulty of translating domestic or informal roles into paid work abroad. Similarly, being retired, studying, unemployed, or involved in “other” activities generally predicts lower employment odds across countries, underscoring how non-active labor market status prior to migration can limit integration opportunities. Motivation plays an important role in getting employed. In fact, individuals not looking for work are consistently much less likely to be employed, with odds reduced by over 70% in several countries. Additionally, some countries reveal a paradoxical association where experiencing hostility or verbal aggression correlates with higher employment. It can possibly be attributed to greater public exposure or social interaction among employed refugees.

**Social Benefits and Support:** Receiving social protection or unemployment benefits tends to lower employment odds, with reductions ranging from around 16% in Poland to over 88% in Estonia. This likely reflects the temporary reliance on such supports during job searches rather than disincentives to work per se. Notably, in Romania, needing host government assistance surprisingly associates with increased employment odds, perhaps indicating effective linkage between aid and job placement in that context. Poland draws a picture where income sources like remittances and Ukrainian government benefits are linked to lower employment odds, suggesting dependency effects. In Slovakia, host government and humanitarian assistance are both associated with decreased employment chances, signaling potential gaps in support effectiveness.

**Barriers and No Difficulties:** Refugees reporting no difficulties related to employment show higher chances of working—ranging from a 4-time increase in Romania to over a 10-time increase in Moldova. Reporting language barriers often correlates with higher odds of employment, notably in Poland (134% increase) and Moldova (336% increase). This counterintuitive pattern may reflect motivated individuals actively seeking employment despite language difficulties or varying degrees of integration support. Similarly, lacking formal skills or educational qualifications sometimes corresponds with higher employment odds, which may be linked to greater awareness of skill gaps among these individuals or employment in low-qualification entry-level fields. Estonia stands out for the large negative impact of lacking documentation and the strong association between perceived loss of benefits and increased employment odds.

# Discussion: Policy Lessons from Diverging Outcomes

# Conclusion: Toward Durable Solutions

# References

- Jirka, Luděk, et al. “High-Skilled Precarity: The Situation of Ukrainian Refugees in the Czech Republic and Poland.” Sociological Studios, no. 2(23), Lesya Ukrainka Volyn National University, Dec. 2023, pp. 41–48. Crossref, doi:10.29038/2306-3971-2023-02-24-24.

- OECD (2023), “What we know about the skills and early labour market outcomes of refugees from Ukraine”, OECD Policy Responses on the Impacts of the War in Ukraine, OECD Publishing, Paris, https://doi.org/10.1787/c7e694aa-en.

- Londar, S., et al. “Challenges for Ukrainian Refugees in the EU Labour Market: The Case of Poland and Germany.” Educational Analytics of Ukraine, no. 5, State Scientific Institution - Institute of Educational Analytics, 2024, pp. 5–16. Crossref, doi:10.32987/2617-8532-2024-5-5-16.

- SocioFactor, IOM, Impact-REACH, SHC, Sociofactor, TARKI Social Research Institute, Ipsos, UNHCR (2023). Poland, Slovak Republic, Hungary, Czech Republic, Moldova, Romania, Bulgaria: Multi-Sector Needs Assessment (MSNA) - 2023. Accessed from: https://microdata.unhcr.org

- UNHCR (2023). Estonia: Multi-Sector Needs Assessment (MSNA) - 2023. Accessed from: https://microdata.unhcr.org


# Figures

```{r, fig.height = 6, fig.width=8, warning=FALSE, echo=FALSE, fig.cap = "The distribution of the highest completed level of education among Ukrainian refugees in six Central and Eastern European countries."}

combined_data |>
  filter(!country %in% c("Hungary", "Bulgaria", "construct", NA)) |>
  mutate(demographics_educ_level = case_when(
    grepl("tech", demographics_educ_level, 
          ignore.case = TRUE) ~ "Technical",
    grepl("sec", demographics_educ_level, 
          ignore.case = TRUE) ~ "Secondary",
    grepl("pri", demographics_educ_level, 
          ignore.case = TRUE) ~ "Primary",
    grepl("phd", demographics_educ_level, 
          ignore.case = TRUE) ~ "PhD",
    grepl("master", demographics_educ_level, 
          ignore.case = TRUE) ~ "Master's",
    grepl("bachelor", demographics_educ_level, 
          ignore.case = TRUE) ~ "Bachelor's",
    grepl("no_edu", demographics_educ_level, 
          ignore.case = TRUE) ~ "No Education",
    grepl("prefer", demographics_educ_level, 
          ignore.case = TRUE) ~ "No Answer",
    grepl("spec", demographics_educ_level, 
          ignore.case = TRUE) ~ "Specialization",
    TRUE ~ demographics_educ_level
  )) |>
  filter(!is.na(demographics_educ_level) & 
           demographics_educ_level != "No Answer") |>
  count(country, demographics_educ_level) |>
  group_by(country) |>
  mutate(prop = n / sum(n) * 100) |>
  arrange(desc(prop), .by_group = TRUE) |>
    slice_head(n = 5) |>
    ungroup() |>
  ggplot(aes(x = reorder(demographics_educ_level, -prop), 
             y = prop, fill = demographics_educ_level)) +
  geom_col() +
  facet_wrap(~country, scales = "free_x") +
  xlab("Education Level") +
  ylab("Percent") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.8, size = 6)) +
  guides(fill = guide_legend(title = "Education Level")) +
  scale_fill_brewer(palette = "Dark2")

```

```{r, fig.height = 3.5, fig.width=8, echo=FALSE, warning=FALSE, fig.cap="Employment status of Ukrainian refugees before displacement and after arrival in the EU."}

act_host <- combined_data |>
  filter(
    !is.na(host_country_work_coa),
    !country %in% c("Hungary", "Bulgaria", "construct", NA)
  ) |>
  count(country, host_country_work_coa) |>
  group_by(country) |>
  mutate(percent = n / sum(n) * 100) |>
  ggplot(aes(x = country, y = percent, 
             fill = fct_infreq(host_country_work_coa))) +
  geom_col() +
  xlab("Country") +
  ggtitle("Host Country Activities") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45,  hjust = 0.8, size = 6),
    legend.position = "right"
  ) +
  guides(fill = guide_legend(title = "Activity")) +
  scale_fill_brewer(palette = "Dark2") + 
  theme(legend.position = "none") + ylab(NULL)

act_ukr <- combined_data|>
  filter(
    !is.na(host_country_work_coa),
    !country %in% c("Hungary", "Bulgaria", "construct", NA)
  ) |>
  filter(!is.na(demographics_resp_activity), 
         demographics_resp_activity != "No Answer") |>
  count(country, demographics_resp_activity) |>
  group_by(country) |>
  mutate(percent = n / sum(n) * 100) |>
  ggplot(aes(x = country, y = percent, 
             fill = demographics_resp_activity)) +
  geom_col(position = "stack") +
  xlab("Country") +
  ylab("Percent") +
  ggtitle("Employment Activity in Ukraine") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45,  hjust = 0.8, size = 6),
    legend.position = "right"
  ) +
  guides(fill = guide_legend(title = "Activity Type")) +
  scale_fill_brewer(palette = "Dark2") + theme(legend.position = "none")

shared_legend <- get_legend(act_host + theme(legend.position = "right"))

combined_plot <- plot_grid(
  act_ukr, act_host,
  labels = NULL,
  ncol = 2,
  align = "hv"
)
plot_grid(
  combined_plot, shared_legend,
  ncol = 2,  
  rel_widths = c(0.5, 0.2)
)
```

```{r, fig.height = 6, fig.width=8, echo=FALSE, fig.cap="Reported barriers to employment among Ukrainian refugees"}

#Aggregated data

combined_df |>
  filter(!Country %in% c("Hungary", "Bulgaria", "construct", NA)) |>
    filter(Source == "job") |>
    mutate(Percent = round(Total_Proportion * 100, 2)) |>
    select(Component, Percent, Country) |>
    group_by(Country) |>
    arrange(desc(Percent), .by_group = TRUE) |>
    slice_head(n = 5) |>
    ungroup() |> 
  ggplot(aes(x = reorder(Component, -Percent), 
             y = Percent, fill = Component)) +
  geom_col(show.legend = TRUE) +
  facet_wrap(~Country, scales = "free_x") +
  xlab("Income Source") + ylab("Percent") +
  ggtitle("Problems with Finding Employment") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,  hjust = 1, size = 6)) +
  guides(fill = guide_legend(title = "Reasons")) +
  scale_fill_brewer(palette = "Dark2")
```

```{r, fig.height = 6, fig.width=8, echo=FALSE, fig.cap="The distribution of reported income sources by country"}

#Aggregated data

combined_df |>
    filter(Source == "income") |>
    mutate(Percent = round(Total_Proportion * 100, 2))|>
    select(Component, Percent, Country) |>
    group_by(Country) |>
    arrange(desc(Percent), .by_group = TRUE) |>
    slice_head(n = 5) |>
    ungroup() |> 
  ggplot(aes(x = reorder(Component, -Percent), 
             y = Percent, fill = Component)) +
  geom_col(show.legend = TRUE) +
  facet_wrap(~Country, scales = "free_x") +
  xlab("Income Source") + ylab("Percent") +
  ggtitle("Comparison of Reported Income Sources by Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,  hjust = 1, size = 6)) +
  guides(fill = guide_legend(title = "Income Source"))+
  scale_fill_brewer(palette = "Dark2")

```

```{r, fig.height = 5, fig.width=8, echo=FALSE, fig.cap="Distribution of social protection benefits by country"}
combined_df |>
  filter(!Country %in% c("Hungary", "Bulgaria", "construct", NA)) |>
    filter(Source == "benefits") |>
    mutate(Percent = round(Total_Proportion * 100, 2)) |>
    select(Component, Percent, Country) |>
    group_by(Country) |>
    arrange(desc(Percent), .by_group = TRUE) |>
    slice_head(n = 5) |>
    ungroup() |> 
  ggplot(aes(x = reorder(Component, -Percent), 
             y = Percent, fill = Component)) +
  geom_col(show.legend = TRUE) +
  facet_wrap(~Country, scales = "free_x") +
  xlab("Income Source") + ylab("Percent") +
  ggtitle("Social Protection Benefits from Host Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,  hjust = 0.8, size = 6)) +
  guides(fill = guide_legend(title = "Type")) +
  scale_fill_brewer(palette = "Dark2")
```

```{r}

vars_pl <- c(
  "introduction_resp_age",
  "demographics_resp_activity",
  "income_social_protection_host_govt",
  "income_remmittances",
  "income_social_protection_ukr_govt",
  "diff_lack_of_lang",
  "diff_lack_childcare",
  "diff_lack_of_skills",
  "diff_lack_of_education_skills",
  "diff_none",
  "income_remmittances", 
  "diff_lack_childcare",
  "diff_not_looking_for_work",
  "diff_lack_of_age_opportunities"
)
vars_ee <- c(
  "demographics_resp_activity",
  "diff_lack_of_lang",
  "diff_lack_of_documentation",
  "benefits_cash_benefits",
  "benefits_unemployment_grant",
  "hostile_comments_social_media",
  "diff_loss_benefits",
  "needs_employment"
)
vars_cz <- c(
  "demographics_resp_activity",
  "income_social_protection_host_govt",
  "diff_lack_of_lang",
  "diff_none",
  "hostile_verbal_aggression",
  "diff_lack_of_decent_employment",
  "diff_lack_childcare",
  "diff_not_looking_for_work"
)
vars_ml <- c(
  "demographics_resp_activity",
  "diff_lack_of_lang",
  "diff_lack_of_skills",
  "diff_lack_of_info",
  "diff_none",
  "needs_medical",
  "diff_need_to_take_care_of_others",
  "needs_humanitarian_assistance"
)
vars_ro <- c(
  "introduction_resp_age",
  "demographics_resp_activity",
  "diff_lack_of_decent_employment",
  "diff_lack_childcare",
  "diff_none",
  "needs_host_govt_assistance",
  "income_other_sources",
  "diff_lack_of_skills",
  "diff_need_to_take_care_of_others",
  "diff_not_looking_for_work"
)
vars_sk <- c(
  "introduction_resp_age",
  "demographics_resp_activity",
  "income_social_protection_host_govt",
  "diff_lack_of_skills",
  "diff_not_looking_for_work",
  "needs_host_govt_assistance",
  "needs_humanitarian_assistance",
  "diff_none",
  "needs_host_govt_assistance",
  "benefits_cash_benefits"
)

all_vars <- sort(unique(c(vars_pl, vars_ee, vars_cz, vars_ml, vars_ro, vars_sk)))
df <- data.frame(
  Predictor = all_vars,
  Poland = ifelse(all_vars %in% vars_pl, "✔", ""),
  Estonia = ifelse(all_vars %in% vars_ee, "✔", ""),
  Czechia = ifelse(all_vars %in% vars_cz, "✔", ""),
  Moldova = ifelse(all_vars %in% vars_ml, "✔", ""),
  Romania = ifelse(all_vars %in% vars_ro, "✔", ""),
  Slovakia = ifelse(all_vars %in% vars_sk, "✔", ""),
  stringsAsFactors = FALSE
)
df |>
  kable(booktabs = TRUE, align = "c",
        col.names = c("Predictor", "Poland", "Estonia", "Czechia", "Moldova", "Romania", "Slovakia")) |>
  kable_styling(latex_options = c("striped"), font_size = 12) |>
  column_spec(1, bold = TRUE, width = "10cm") |>
  row_spec(0, bold = TRUE, color = "white", background = "gray") |>
  add_header_above(c(" " = 1, "Selected Predictors by Country" = 6))


```

**Estonia graphs for popular article**

```{r}
# Filter & recode activities in Estonia
act_host_data <- combined_data |>
  filter(
    country == "Estonia",
    !is.na(host_country_work_coa)
  ) 

# Count and calculate percentage
act_host_summary <- act_host_data |>
  count(host_country_work_coa, name = "n_host") |>
  mutate(percent_host = round(n_host / sum(n_host) * 100, 1))


# Filter & recode activities in Ukraine
act_ukr_data <- combined_data |>
  filter(
    country == "Estonia",
    !is.na(demographics_resp_activity),
    demographics_resp_activity != "No Answer"
  ) 

# Count and calculate percentage
act_ukr_summary <- act_ukr_data |>
  count(demographics_resp_activity, name = "n_ukr") |>
  mutate(percent_ukr = round(n_ukr / sum(n_ukr) * 100, 1))


# Merge summaries for comparison
activity_comparison <- full_join(
  act_ukr_summary,
  act_host_summary,
  by = c("demographics_resp_activity" = "host_country_work_coa")
)

activity_comparison
```

```{r, fig.height = 4, fig.width=7, echo=FALSE}
combined_df |>
  filter(!Country %in% c("Hungary", "Bulgaria", "construct", NA)) |>
    filter(Source == "needs", Country == "Estonia") |>
  mutate(Component = fct_recode(Component,
    "Жилье" = "Accommodation",
    "Обучение" = "Education",
    "Трудоустройство" = "Employment",
    "Медицина" = "Healthcare",
    "Никаких" = "None",
  )) |>
    mutate(Percent = round(Total_Proportion * 100, 2)) |>
    select(Component, Percent, Country) |>
    group_by(Country) |>
    arrange(desc(Percent), .by_group = TRUE) |>
    slice_head(n = 5) |>
    ungroup() |>
  ggplot(aes(x = reorder(Component, Percent), 
             y = Percent, fill = Component)) +
  geom_col(show.legend = TRUE) +
  geom_text(aes(label = paste0(Percent, "%")), 
            hjust = -0.1, size = 3) +
  coord_flip() +
  xlab("Нужды") + ylab("Проценты") +
  ggtitle("Социально-экономические потребности украинцев") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
         legend.position = "none"
        ) +
  guides(fill = guide_legend(title = "Type")) +
  scale_fill_brewer(palette = "Dark2") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

```{r, fig.height = 4, fig.width=6.7, echo=FALSE}

act_host <- combined_data |>
  filter(
    !is.na(host_country_work_coa),
    country == "Estonia"
  ) |>
  mutate(host_country_work_coa = factor(host_country_work_coa))|>
  mutate(host_country_work_coa = fct_recode(
  host_country_work_coa,
  "Работал(-а)" = "Employed",
  "Учился(-ась)" = "Studying",
  "Занимался(-ась) домом" = "Housekeeping",
  "Стажер" = "Trainee",
  "Вышел(-ла) на пенсию" = "Retired",
  "Нетрудоустроенный(-ая)" = "Unemployed",
  "Болезнь или травма" = "Long term illness/injury",
  "Другое" = "Other"
))|>
  count(country, host_country_work_coa) |>
  mutate(percent = n / sum(n) * 100) |>
  ggplot(aes(x = country, y = percent, fill = host_country_work_coa)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(axis.text.x = element_blank(), axis.title.x = element_blank()) +
  guides(fill = guide_legend(title = "Тип деятельности")) +
  scale_fill_brewer(palette = "Dark2") +
  theme(legend.position = "none") +
  ylab(element_blank()) +
  ggtitle( " ",
    subtitle = "Занятость в Эстонии"
  )

act_ukr <- combined_data |>
  filter(
    country == "Estonia"
  ) |>
  mutate(demographics_resp_activity = fct_recode(
  demographics_resp_activity,
  "Работал(-а)" = "Employed",
  "Учился(-ась)" = "Studying",
  "Занимался(-ась) домом" = "Housekeeping",
  "Стажер" = "Trainee",
  "Вышел(-ла) на пенсию" = "Retired",
  "Нетрудоустроенный(-ая)" = "Unemployed",
  "Болезнь или травма" = "Long term illness/injury",
  "Другое" = "Other"
))|>
  filter(!is.na(demographics_resp_activity), demographics_resp_activity != "No Answer") |>
  count(country, demographics_resp_activity) |>
  mutate(percent = n / sum(n) * 100) |>
  ggplot(aes(x = country, y = percent, fill = demographics_resp_activity)) +
  geom_bar(stat = "identity") +
  ylab("Проценты") +
  theme_minimal() +
  theme(axis.text.x = element_blank(), axis.title.x = element_blank()) +
  guides(fill = guide_legend(title = "Activity Type")) +
  scale_fill_brewer(palette = "Dark2") +
  theme(legend.position = "none" )+
  ggtitle(
    "Рабочая активность украинцев до и после переезда в Эстонию (2023)",
    subtitle = "Занятость в Украине"
  )

# Shared legend
shared_legend <- get_legend(
  act_host + theme(legend.position = "right")
)

# Combined plot
combined_plot <- plot_grid(
  act_ukr, act_host,
  labels = NULL,
  ncol = 2,
  align = "hv"
)

plot_grid(
  combined_plot, shared_legend,
  ncol = 2,
  rel_widths = c(0.19, 0.1)
)

```

```{r, fig.width=7, fig.height=5, warning=FALSE, echo=FALSE}

combined_data |>
  filter(
    country == "Estonia",
    !is.na(demographics_educ_level),
    !is.na(introduction_resp_age)
  ) |>
  mutate(demographics_educ_level = case_when(
    grepl("tech", demographics_educ_level, ignore.case = TRUE) ~ "Техническое",
    grepl("sec", demographics_educ_level, ignore.case = TRUE) ~ "Среднее",
    grepl("pri", demographics_educ_level, ignore.case = TRUE) ~ "Начальное",
    grepl("phd", demographics_educ_level, ignore.case = TRUE) ~ "Докторантура",
    grepl("master", demographics_educ_level, ignore.case = TRUE) ~ "Магистратура",
    grepl("bachelor", demographics_educ_level, ignore.case = TRUE) ~ "Бакалавриат",
    grepl("no_edu", demographics_educ_level, ignore.case = TRUE) ~ "Без образования",
    grepl("prefer", demographics_educ_level, ignore.case = TRUE) ~ "Без ответа",
    grepl("spec", demographics_educ_level, ignore.case = TRUE) ~ "Специализация",
    TRUE ~ demographics_educ_level
  )) |>
  filter(demographics_educ_level != "Без ответа") |>
  count(introduction_resp_age, demographics_educ_level) |>
  group_by(introduction_resp_age) |>
  mutate(prop = n / sum(n) * 100) |>
  ungroup() |>
  mutate(demographics_educ_level = fct_reorder(demographics_educ_level, n, .fun = sum, .desc = TRUE)) |>
  ggplot(aes(x = introduction_resp_age, y = prop, fill = demographics_educ_level)) +
  geom_col(position = "stack") +
  xlab("Возраст") +
  ylab("Проценты") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(fill = guide_legend(title = "Уровень образования")) +
  scale_fill_brewer(palette = "Dark2") +
  ggtitle("Уровень образования по возрастным группам украинцев в Эстонии (2023)")


```

```{r, fig.height = 4, fig.width=7, echo=FALSE}

#Aggregated data

combined_df |>
  filter(Country == "Estonia", Source == "job") |>
  mutate(Component = fct_recode(Component,
    "Языковой барьер" = "Language barrier",
    "Нет препятствий" = "None",
    "Недостаток возможностей" = "Insuffisient opportunities",
    "Непризнание квалификаций" = "Lack of recognition",
    "Другое" = "other",
    "Не планирую оставаться" = "not_staying",
    "Уход за другими" = "Care for others",
    "Нет разрешения на работу" = "lack_permit",
    "Дискриминация" = "discrim",
    "Потеря пособий" = "loss_benefits",
    "Предпочитаю не отвечать" = "prefer_no_answer",
    "Нет адреса" = "lack_address",
    "Нет информации" = "lack_info",
    "Нет документов" = "lack_docum"
  )) |>
  mutate(Percent = round(Total_Proportion * 100, 2)) |>
  select(Component, Percent, Country) |>
  group_by(Country) |>
  arrange(desc(Percent), .by_group = TRUE) |>
  slice_head(n = 5) |>
  ungroup() |> 
  ggplot(aes(x = reorder(Component, Percent), 
             y = Percent, fill = Component)) +
  geom_col(show.legend = TRUE) +
  geom_text(aes(label = paste0(Percent, "%")), 
            hjust = -0.1, size = 3) +
  xlab("Причина") + 
  ylab("Проценты") +
  ggtitle("Основные препятствия для трудоустройства украинцев") +
  theme_minimal() +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 35,  hjust = 1, size = 6),
        legend.position = "none") +
  scale_fill_brewer(palette = "Dark2")+
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))

```

```{r, fig.height = 4, fig.width=7, echo=FALSE}

#Aggregated data

combined_df |>
  filter(Country == "Estonia", Source == "cohesion") |>
   mutate(Component = fct_recode(Component,
    "Вербальная агрессия" = "verbal_aggression",
    "Никаких" = "none",
    "Негатив в соцсетях" = "comments_social_media",
    "Дискриминация" = "discriminatory_behavior",
    "Другое" = "other"
  )) |>
  mutate(Percent = round(Total_Proportion * 100, 2)) |>
  select(Component, Percent, Country) |>
  group_by(Country) |>
  arrange(desc(Percent), .by_group = TRUE) |>
  slice_head(n = 5) |>
  ungroup() |> 
  ggplot(aes(x = reorder(Component, Percent), 
             y = Percent, fill = Component)) +
  geom_col(show.legend = TRUE) +
  geom_text(aes(label = paste0(Percent, "%")), 
            hjust = -0.1, size = 3) +
  xlab("Тип препятствия") + 
  ylab("Проценты") +
  ggtitle("Основные проявления дискриминации и социальной изоляции") +
  theme_minimal() +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 35,  hjust = 1, size = 6),
        legend.position = "none") +
  scale_fill_brewer(palette = "Dark2")+
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))

```

```{r, fig.height = 4, fig.width=7, echo=FALSE}

#Aggregated data

combined_df |>
    filter(Source == "income", Country == "Estonia") |>
  mutate(Component = fct_recode(Component,
    "Работа" = "Job",
    "Социальная защита" = "Social Protection",
    "Нет дохода" = "No income",
    "Другие источники" = "Other Sources",
    "Социальная защита в Украине" = "Social Protection from Ukraine"
  )) |>
    mutate(Percent = round(Total_Proportion * 100, 2))|>
    select(Component, Percent, Country) |>
    group_by(Country) |>
    arrange(desc(Percent), .by_group = TRUE) |>
    slice_head(n = 5) |>
    ungroup() |> 
  ggplot(aes(x = reorder(Component, Percent), 
             y = Percent, fill = Component)) +
   geom_col(show.legend = TRUE) +
  geom_text(aes(label = paste0(Percent, "%")), 
            hjust = -0.1, size = 3) +
  xlab("Источник дохода") + ylab("Проценты") +
  ggtitle("Источники дохода украинцев в Эстонии") +
  theme_minimal() +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 35,  hjust = 1, size = 6),
        legend.position = "none") +
  scale_fill_brewer(palette = "Dark2")+
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))

```

```{r}

# Function to create a clean proportion table
make_prop_table <- function(variable, na.rm = FALSE) {
  if (na.rm) {
    variable <- variable[!is.na(variable)]
  }

  tab <- table(variable)
  
  tibble::tibble(
    Category = names(tab),
    Count = as.numeric(tab),
    Percent = round(100 * prop.table(tab), 2)
  )
}

rus_labels <- c(
  "dont_know" = "Затрудняюсь ответить",
  "fewer" = "Меньше, чем до войны",
  "more" = "Больше, чем до войны",
  "prefer_not_to_answer" = "Предпочитаю не отвечать",
  "same" = "Примерно столько же"
)

# Generate and format table
make_prop_table(data_ee$economic_capicity_L13_SS_AFF_GOODS, na.rm = TRUE) |>
 mutate(Category = rus_labels[Category]) |>
  kable(booktabs = TRUE, align = "c",
        col.names = c("Ответ", "Количество", "Процент"))|>
  kable_styling(latex_options = c("striped"), font_size = 12) |>
  column_spec(1, bold = TRUE) |>
  row_spec(0, bold = TRUE, color = "white", background = "gray") |>
  add_header_above(c("Способность приобретать товары по сравнению с довоенным временем" = 3))

make_prop_table(data_ee$economic_capicity_L13_1_SM_MORE_GOODS)
make_prop_table(data_ee$economic_capicity_L13_1_SM_LESS_GOODS)
```


```{r}
ggplot(data_ee, aes(x = host_country_healthcare_access, 
                             fill = host_country_healthcare_access)) +
  geom_bar(stat = "count") +
  xlab("Problems accessing Healthcare Services") +
  ylab("Count") +
  scale_fill_brewer(palette = "Paired") 

combined_df |>
  filter(Source == "med_issues") |>
  mutate(Percent = round(Total_Proportion * 100, 2)) |>
  select(Component, Percent) |>
  arrange(desc(Percent))

```
